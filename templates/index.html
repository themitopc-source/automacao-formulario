<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Automatizador Web (Flask + Playwright)</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
<div class="container">
  <h1>Automatizador Web <small>(Flask + Playwright)</small></h1>

  <section class="card">
    <h2>Licença</h2>
    <div id="lic-status" class="muted">Validar com THEMITO (30d) ou THEMITO10 (90d).</div>
    <form id="lic-form" onsubmit="return false;">
      <input id="lic-key" placeholder="Insira a chave" />
      <button onclick="validateLicense()">Validar licença</button>
    </form>
  </section>

  <section class="card">
    <h2>Envio único</h2>
    <form id="form-send" onsubmit="return false;">
      <label>URL do Form:<input name="form_url" value="{{ st.last_values.form_url }}"/></label>
      <label>Classificação:<input name="classificacao" value="{{ st.last_values.classificacao }}"/></label>
      <label>Empresa:<input name="empresa" value="{{ st.last_values.empresa }}"/></label>
      <label>Unidade:
        <select name="unidade">
          {% for u in unidades %}
            <option value="{{u}}" {% if u == st.last_values.unidade %}selected{% endif %}>{{u}}</option>
          {% endfor %}
        </select>
      </label>
      <label>Data:<input name="data" value="{{ st.last_values.data }}"/></label>
      <label>Hora:
        <select name="hora">
          {% for h in hora_opts %}
            <option value="{{h}}" {% if h == st.last_values.hora %}selected{% endif %}>{{h}}</option>
          {% endfor %}
        </select>
      </label>
      <label>Turno:<input name="turno" value="{{ st.last_values.turno }}"/></label>
      <label>Área:
        <select name="area">
          {% for a in areas %}
            <option value="{{a}}" {% if a == st.last_values.area %}selected{% endif %}>{{a}}</option>
          {% endfor %}
        </select>
      </label>
      <label>Setor:<input name="setor" value="{{ st.last_values.setor }}"/></label>
      <label>Atividade:<input name="atividade" value="{{ st.last_values.atividade }}"/></label>
      <label>Intervenção:<input name="intervencao" value="{{ st.last_values.intervencao }}"/></label>
      <label>CS:<input name="cs" value="{{ st.last_values.cs }}"/></label>
      <label>Observação:
        <select name="observacao">
          {% for o in obs_opts %}
            <option value="{{o}}" {% if o == st.observacao[0] %}selected{% endif %}>{{o}}</option>
          {% endfor %}
        </select>
      </label>
      <label>Descrição:<textarea name="descricao">{{ st.last_values.descricao }}</textarea></label>
      <label>Fiz:<textarea name="fiz">{{ st.last_values.fiz }}</textarea></label>
      <button onclick="sendOnce()">Preencher e Enviar</button>
    </form>
  </section>

  <section class="card">
    <h2>Enviar 10x (datas regressivas)</h2>
    <form id="form-send10" onsubmit="return false;">
      <!-- reutiliza os mesmos campos do form acima via JS -->
      <button onclick="sendTen()">10x</button>
    </form>
  </section>

  <section class="card">
    <h2>Dados salvos (/saved)</h2>
    <button onclick="fetchSaved()">Ver JSON</button>
    <pre id="saved-json" class="code"></pre>
  </section>
</div>

<script>
async function validateLicense(){
  const key = document.getElementById('lic-key').value.trim();
  const r = await fetch('/license/validate', {method:'POST', body: new URLSearchParams({key})});
  const j = await r.json();
  const el = document.getElementById('lic-status');
  if(j.ok){
    el.textContent = 'Licença válida até: ' + j.expires;
    el.className = 'ok';
  }else{
    el.textContent = 'Licença inválida';
    el.className = 'err';
  }
}

function formToParams(formId){
  const f = document.getElementById(formId) || document.getElementById('form-send');
  const data = new FormData(f);
  // pega também campos do form principal (caso chame do 10x)
  const main = new FormData(document.getElementById('form-send'));
  for (const [k,v] of main.entries()) if(!data.has(k)) data.append(k,v);
  return new URLSearchParams(data);
}

async function sendOnce(){
  const params = formToParams('form-send');
  const r = await fetch('/send', {method:'POST', body: params});
  const j = await r.json();
  alert(JSON.stringify(j));
}

async function sendTen(){
  const params = formToParams('form-send10');
  const r = await fetch('/send10', {method:'POST', body: params});
  const j = await r.json();
  alert(JSON.stringify(j));
}

async function fetchSaved(){
  const r = await fetch('/saved');
  const j = await r.json();
  document.getElementById('saved-json').textContent = JSON.stringify(j, null, 2);
}
</script>
</body>
</html>
